<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>COD Status Bot Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="/static/css/dashboard.css" rel="stylesheet">
</head>
<body>
<header role="banner">
    <h1>COD Status Bot Admin Dashboard</h1>
    <a href="/admin/logout" class="logout-btn" role="button" aria-label="Logout">Logout</a>
</header>
<div style="text-align: center; margin: 10px 0;" role="group" aria-label="Theme Controls">
    <label for="theme-toggle">Dark Mode</label>
    <input type="checkbox" id="theme-toggle" aria-label="Toggle dark mode" onclick="toggleDarkMode()"
           onkeydown="handleKeyDown(event)">
</div>
<div class="container">
    <div class="stat-group" draggable="true" data-stat-group-id="AccountStatistics" role="region"
         aria-label="Account Statistics">
        <h2><i class="fas fa-user"></i> Account Statistics</h2>
        <button class="toggle-chart-btn" onclick="toggleStatChart(this)">Show Chart</button>
        <div class="stat-item">Total Accounts: <span id="totalAccounts">{{.TotalAccounts}}</span></div>
        <div class="stat-item">Active Accounts: <span id="activeAccounts">{{.ActiveAccounts}}</span></div>
        <div class="stat-item">Banned Accounts: <span id="bannedAccounts">{{.BannedAccounts}}</span></div>
        <div class="stat-item">Oldest Account: <span>{{.OldestAccount.Format "2006-01-02"}}</span></div>
        <div class="stat-item">Newest Account: <span>{{.NewestAccount.Format "2006-01-02"}}</span></div>
        <div class="chart-container">
            <canvas id="accountChart"></canvas>
        </div>
    </div>
    <div class="stat-group" draggable="true" data-stat-group-id="UserStatistics" role="region"
         aria-label="UserStatistics">
        <h2><i class="fas fa-users"></i> User Statistics</h2>
        <button class="toggle-chart-btn" onclick="toggleStatChart(this)">Show Chart</button>
        <div class="stat-item">Total Users: <span id="totalUsers">{{.TotalUsers}}</span></div>
        <div class="stat-item">Users with Custom API Key: <span
                id="usersWithCustomAPIKey">{{.UsersWithCustomAPIKey}}</span></div>
        <div class="stat-item">Average Accounts per User: <span id="averageAccountsPerUser">{{printf "%.2f" .AverageAccountsPerUser}}</span>
        </div>
        <div class="chart-container">
            <canvas id="userChart"></canvas>
        </div>
    </div>
    <div class="stat-group" draggable="true" data-stat-group-id="CheckStatistics" role="region"
         aria-label="CheckStatistics">
        <h2><i class="fas fa-check"></i> Check Statistics</h2>
        <button class="toggle-chart-btn" onclick="toggleStatChart(this)">Show Chart</button>
        <div class="stat-item">Checks Last Hour: <span id="checksLastHour">{{.ChecksLastHour}}</span></div>
        <div class="stat-item">Checks Last 24 Hours: <span id="checksLast24Hours">{{.ChecksLast24Hours}}</span></div>
        <div class="stat-item">Average Checks per Day: <span id="averageChecksPerDay">{{printf "%.2f" .AverageChecksPerDay}}</span>
        </div>
        <div class="chart-container">
            <canvas id="checkChart"></canvas>
        </div>
    </div>
    <div class="stat-group" draggable="true" data-stat-group-id="BanStatistics" role="region"
         aria-label="BanStatistics">
        <h2><i class="fas fa-ban"></i> Ban Statistics</h2>
        <button class="toggle-chart-btn" onclick="toggleStatChart(this)">Show Chart</button>
        <div class="stat-item">Total Bans: <span id="totalBans">{{.TotalBans}}</span></div>
        <div class="stat-item">Recent Bans (24h): <span id="recentBans">{{.RecentBans}}</span></div>
        <div class="stat-item">Total Shadowbans: <span id="totalShadowbans">{{.TotalShadowbans}}</span></div>
        <div class="stat-item">Total Temporary Bans: <span id="totalTempbans">{{.TotalTempbans}}</span></div>
        <div class="chart-container">
            <canvas id="banChart"></canvas>
        </div>
    </div>
    <div class="stat-group" draggable="true" data-stat-group-id="NotificationStatistics" role="region"
         aria-label="NotificationStatistics">
        <h2><i class="fas fa-bell"></i> Notification Statistics</h2>
        <button class="toggle-chart-btn" onclick="toggleStatChart(this)">Show Chart</button>
        <div class="stat-item">Total Notifications: <span id="totalNotifications">{{.TotalNotifications}}</span></div>
        <div class="stat-item">Recent Notifications (24h): <span
                id="recentNotifications">{{.RecentNotifications}}</span></div>
        <div class="chart-container">
            <canvas id="notificationChart"></canvas>
        </div>
    </div>
</div>
<script>
    let charts = {};

    const chartConfigs = {
        accountChart: {
            label: 'Accounts',
            datasets: [{
                label: 'Total Accounts',
                color: 'rgba(75, 192, 192, 1)',
                bgColor: 'rgba(75, 192, 192, 0.2)'
            }, {
                label: 'Active Accounts',
                color: 'rgba(54, 162, 235, 1)',
                bgColor: 'rgba(54, 162, 235, 0.2)'
            }, {label: 'Banned Accounts', color: 'rgba(255, 99, 132, 1)', bgColor: 'rgba(255, 99, 132, 0.2)'}]
        },
        userChart: {
            datasets: [{
                label: 'Total Users',
                color: 'rgba(153, 102, 255, 1)',
                bgColor: 'rgba(153, 102, 255, 0.2)'
            }, {label: 'Users with Custom API Key', color: 'rgba(255, 159, 64, 1)', bgColor: 'rgba(255, 159, 64, 0.2)'}]
        },
        checkChart: {
            datasets: [{
                label: 'Hourly Checks',
                color: 'rgba(255, 159, 64, 1)',
                bgColor: 'rgba(255, 159, 64, 0.2)',
                borderDash: [5, 5]
            }, {label: 'Daily Checks', color: 'rgba(75, 192, 192, 1)', bgColor: 'rgba(75, 192, 192, 0.2)'}]
        },
        notificationChart: {
            datasets: [{
                label: 'Total Notifications',
                color: 'rgba(54, 162, 235, 1)',
                bgColor: 'rgba(54, 162, 235, 0.2)'
            }, {label: 'Recent Notifications', color: 'rgba(255, 206, 86, 1)', bgColor: 'rgba(255, 206, 86, 0.2)'}]
        },
        banChart: {
            datasets: [{
                label: 'Total Bans',
                color: 'rgba(255, 99, 132, 1)',
                bgColor: 'rgba(255, 99, 132, 0.2)'
            }, {
                label: 'Shadowbans',
                color: 'rgba(153, 102, 255, 1)',
                bgColor: 'rgba(153, 102, 255, 0.2)'
            }, {label: 'Temporary Bans', color: 'rgba(255, 159, 64, 1)', bgColor: 'rgba(255, 159, 64, 0.2)'}]
        }
    };


    function initializeCharts() {
        if (!window.Chart) {
            console.error('Chart.js not loaded');
            return;
        }

        Object.values(charts).forEach(chart => {
            if (chart) {
                chart.destroy();
            }
        });
        charts = {};

        Object.entries(chartConfigs).forEach(([chartId, config]) => {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: config.datasets.map(dataset => ({
                        label: dataset.label,
                        borderColor: dataset.color,
                        backgroundColor: dataset.bgColor,
                        borderDash: dataset.borderDash || [],
                        data: [],
                        tension: 0.4,
                        fill: true
                    }))
                },
                options: {
                    ...getChartOptions(),
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        tooltip: {
                            enabled: true,
                            mode: 'index'
                        }
                    }
                }
            });
        });
    }

    function toggleDarkMode() {
        const body = document.body;
        const isDark = body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', isDark);
        updateChartsTheme(isDark);
    }

    function updateChartsTheme(isDark) {
        const textColor = isDark ? '#ffffff' : '#333333';
        Object.values(charts).forEach(chart => {
            if (chart) {
                chart.options.plugins.legend.labels.color = textColor;
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.y.ticks.color = textColor;
                chart.options.scales.x.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                chart.options.scales.y.grid.color = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                chart.update();
            }
        });
    }

    function toggleStatChart(button) {
        const chartContainer = button.parentElement.querySelector('.chart-container');
        const statGroupId = button.parentElement.getAttribute('data-stat-group-id');
        const isHidden = chartContainer.style.display === 'none' || chartContainer.style.display === '';

        chartContainer.style.display = isHidden ? 'block' : 'none';
        button.textContent = isHidden ? 'Hide Chart' : 'Show Chart';
        localStorage.setItem(`chartVisible_${statGroupId}`, isHidden ? 'visible' : 'hidden');
    }

    function initializeDragAndDrop() {
        const statGroups = document.querySelectorAll('.stat-group');
        statGroups.forEach(group => {
            group.setAttribute('draggable', true);
            group.addEventListener('dragstart', handleDragStart);
            group.addEventListener('dragover', handleDragOver);
            group.addEventListener('drop', handleDrop);
            group.addEventListener('dragend', handleDragEnd);
        });
    }

    function addSearchFeature() {
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = 'Search statistics...';
        searchInput.className = 'search-input';

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.stat-group').forEach(group => {
                const text = group.textContent.toLowerCase();
                group.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        document.querySelector('.container').insertAdjacentElement('beforebegin', searchInput);
    }

    function addExportFeature() {
        const exportButton = document.createElement('button');
        exportButton.textContent = 'Export Stats';
        exportButton.className = 'export-button';

        exportButton.addEventListener('click', async () => {
            try {
                const response = await fetch('/admin/stats');
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard-stats-${new Date().toISOString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export failed:', error);
            }
        });

        document.querySelector('.container').insertAdjacentElement('beforebegin', exportButton);
    }

    function getChartOptions() {
        const isDark = document.body.classList.contains('dark-mode');
        const textColor = isDark ? '#ffffff' : '#333333';

        return {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {color: textColor},
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    ticks: {color: textColor},
                    grid: {
                        color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {color: textColor}
                }
            }
        };
    }

    async function updateStats() {
        try {
            const response = await fetch('/admin/stats');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            Object.entries(data).forEach(([key, value]) => {
                const element = document.getElementById(key.toLowerCase());
                if (element) element.textContent = value;
            });

            if (data.accountStatsHistory) {
                Object.entries(charts).forEach(([chartId, chart]) => {
                    const historyKey = chartId.replace('Chart', 'StatsHistory');
                    if (data[historyKey]) {
                        chart.data.labels = data[historyKey].map(item => item.date);
                        chart.data.datasets[0].data = data[historyKey].map(item => item.value);
                        chart.update();
                    }
                });
            }
        } catch (error) {
            console.error('Error updating stats:', error);
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        const draggedHTML = e.dataTransfer.getData('text/html');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = draggedHTML;
        const draggedElement = tempDiv.firstChild;

        this.parentNode.insertBefore(draggedElement, this);

        const originalElement = document.querySelector(`[data-stat-group-id="${draggedElement.getAttribute('data-stat-group-id')}"]`);
        if (originalElement !== draggedElement) {
            originalElement.remove();
        }

        draggedElement.addEventListener('dragstart', handleDragStart);
        draggedElement.addEventListener('dragover', handleDragOver);
        draggedElement.addEventListener('drop', handleDrop);
        draggedElement.addEventListener('dragend', handleDragEnd);

        saveStatGroupPositions();

        const chartCanvas = draggedElement.querySelector('canvas');
        if (chartCanvas) {
            const chartId = chartCanvas.id;
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            initializeCharts();
            updateStats();
        }
    }

    function saveStatGroupPositions() {
        const positions = {};
        document.querySelectorAll('.stat-group').forEach((group, index) => {
            positions[group.getAttribute('data-stat-group-id')] = index;
        });
        localStorage.setItem('statGroupPositions', JSON.stringify(positions));
    }

    function restoreStatGroupPositions() {
        const positions = JSON.parse(localStorage.getItem('statGroupPositions') || '{}');
        const container = document.querySelector('.container');
        const groups = Array.from(document.querySelectorAll('.stat-group'));

        const sortedGroups = Object.entries(positions)
                .sort((a, b) => a[1] - b[1])
                .map(([id]) => groups.find(g => g.getAttribute('data-stat-group-id') === id))
                .filter(Boolean);

        sortedGroups.forEach(group => {
            container.appendChild(group);
        });

        initializeCharts();
        updateStats();
    }

    function syncDarkModeUI() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        document.body.classList.toggle('dark-mode', isDark);
        document.getElementById('theme-toggle').checked = isDark;
        updateChartsTheme(isDark);
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.stat-group:not(.dragging)')]

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return {offset: offset, element: child};
            } else {
                return closest;
            }
        }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        this.style.opacity = '1';
        saveStatGroupPositions();
        initializeCharts();
        updateStats();
    }

    function handleDragStart(e) {
        this.classList.add('dragging');
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const draggable = document.querySelector('.dragging');
        if (!draggable) return;

        const container = document.querySelector('.container');
        const afterElement = getDragAfterElement(container, e.clientY);

        if (afterElement) {
            container.insertBefore(draggable, afterElement);
        } else {
            container.appendChild(draggable);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeCharts();
        initializeDragAndDrop();
        addSearchFeature();
        addExportFeature();
        restoreStatGroupPositions();
        syncDarkModeUI();
        updateStats();
        setInterval(updateStats, 60000);
    });
</script>
</body>
</html>
